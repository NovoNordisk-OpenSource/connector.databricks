<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Reading and Writing Databricks Tables • connector.databricks</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Reading and Writing Databricks Tables">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">connector.databricks</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.5</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/connector-databricks.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/read_write.html">Reading and Writing Databricks Tables</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/novonordisk-opensource/connector.databricks/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Reading and Writing Databricks Tables</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/novonordisk-opensource/connector.databricks/blob/main/vignettes/articles/read_write.Rmd" class="external-link"><code>vignettes/articles/read_write.Rmd</code></a></small>
      <div class="d-none name"><code>read_write.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>This vignette demonstrates how to <strong>read from</strong> and
<strong>write to</strong> Databricks tables using the custom functions.
These functions provide a convenient interface for interacting with
Databricks tables, including features like <a href="https://docs.databricks.com/aws/en/delta/history" class="external-link">time travel</a>
and <a href="https://docs.databricks.com/aws/en/database-objects/tags" class="external-link">tagging</a>.</p>
</div>
<div class="section level2">
<h2 id="setup">Setup<a class="anchor" aria-label="anchor" href="#setup"></a>
</h2>
<p>First, let’s load the necessary libraries and create a connector
object:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://novonordisk-opensource.github.io/connector.databricks">connector.databricks</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create a ConnectorDatabricksTable object</span></span>
<span><span class="va">connector_object</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/connector_databricks_table.html">connector_databricks_table</a></span><span class="op">(</span></span>
<span>  catalog <span class="op">=</span> <span class="st">"my_catalog"</span>,</span>
<span>  schema <span class="op">=</span> <span class="st">"my_schema"</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="writing-to-a-databricks-table">Writing to a Databricks Table<a class="anchor" aria-label="anchor" href="#writing-to-a-databricks-table"></a>
</h2>
<p>To write data to a Databricks table, we use the
<code><a href="../reference/write_cnt.html">write_cnt()</a></code> method:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create sample data</span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  id <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">5</span>,</span>
<span>  name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Alice"</span>, <span class="st">"Bob"</span>, <span class="st">"Charlie"</span>, <span class="st">"David"</span>, <span class="st">"Eve"</span><span class="op">)</span>,</span>
<span>  age <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">25</span>, <span class="fl">30</span>, <span class="fl">35</span>, <span class="fl">40</span>, <span class="fl">45</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Write data to a table</span></span>
<span><span class="va">connector_object</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/write_cnt.html">write_cnt</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="va">data</span>,</span>
<span>    name <span class="op">=</span> <span class="st">"my_table"</span>,</span>
<span>    overwrite <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    tags <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>source <span class="op">=</span> <span class="st">"example"</span>, date <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.Date</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<div class="section level3">
<h3 id="mechanism-for-writing">Mechanism for Writing<a class="anchor" aria-label="anchor" href="#mechanism-for-writing"></a>
</h3>
<p>The <code><a href="../reference/write_cnt.html">write_cnt()</a></code> method for
<code>ConnectorDatabricksTable</code> objects uses a <strong>temporary
volume approach</strong> to write data. Here’s how it works:</p>
<ol style="list-style-type: decimal">
<li>A <strong>temporary volume</strong> is created in the Databricks
file system.</li>
<li>The data is written to this temporary volume as a <a href="https://www.databricks.com/glossary/what-is-parquet" class="external-link"><strong>Parquet</strong></a>
file.</li>
<li>The Parquet file is then converted to a Databricks table using SQL
commands.</li>
<li>If specified, <strong>tags</strong> are added to the table.</li>
<li>Finally, the temporary volume is deleted.</li>
</ol>
<p>This approach allows for <strong>efficient writing of large
datasets</strong> and provides a way to add metadata (tags) to the
table. The use of Parquet as an intermediate format ensures good
performance and compatibility with <a href="https://docs.databricks.com/aws/en/delta/" class="external-link">Databricks’ Delta Lake
architecture</a>.</p>
</div>
</div>
<div class="section level2">
<h2 id="reading-from-a-databricks-table">Reading from a Databricks Table<a class="anchor" aria-label="anchor" href="#reading-from-a-databricks-table"></a>
</h2>
<p>To read data from a Databricks table, we use the
<code><a href="../reference/read_cnt.html">read_cnt()</a></code> method:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Read the entire table</span></span>
<span><span class="va">table_data</span> <span class="op">&lt;-</span> <span class="va">connector_object</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/read_cnt.html">read_cnt</a></span><span class="op">(</span><span class="st">"my_table"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Read the table at a specific timepoint</span></span>
<span><span class="va">historical_data</span> <span class="op">&lt;-</span> <span class="va">connector_object</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/read_cnt.html">read_cnt</a></span><span class="op">(</span><span class="st">"my_table"</span>, timepoint <span class="op">=</span> <span class="st">"2023-06-01 12:00:00 UTC"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Read a specific version of the table</span></span>
<span><span class="va">version_data</span> <span class="op">&lt;-</span> <span class="va">connector_object</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/read_cnt.html">read_cnt</a></span><span class="op">(</span><span class="st">"my_table"</span>, version <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<div class="section level3">
<h3 id="mechanism-for-reading">Mechanism for Reading<a class="anchor" aria-label="anchor" href="#mechanism-for-reading"></a>
</h3>
<p>The <code>read_cnt</code> method for
<code>ConnectorDatabricksTable</code> objects leverages Databricks’ SQL
interface and <a href="(https://docs.databricks.com/aws/en/delta/history)" class="external-link">Delta Lake
time travel capabilities</a>. Here’s how it works:</p>
<ol style="list-style-type: decimal">
<li>A SQL query is constructed based on the table name and any time
travel parameters (timepoint or version).</li>
<li>The query is executed on a Databricks SQL warehouse.</li>
<li>The result is streamed back in <a href="https://arrow.apache.org/overview/" class="external-link">Arrow</a> format for efficient
data transfer.</li>
<li>The Arrow stream is converted to an R data frame.</li>
</ol>
<p>This method supports time travel, allowing you to read historical
versions of the table. The use of Arrow for data transfer provides good
performance, especially for large datasets.</p>
</div>
</div>
<div class="section level2">
<h2 id="listing-tables">Listing Tables<a class="anchor" aria-label="anchor" href="#listing-tables"></a>
</h2>
<p>To list tables in the Databricks catalog, use the
<code><a href="../reference/list_content_cnt.html">list_content_cnt()</a></code> method:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># List all tables</span></span>
<span><span class="va">all_tables</span> <span class="op">&lt;-</span> <span class="va">connector_object</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/list_content_cnt.html">list_content_cnt</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># List tables with specific tags</span></span>
<span><span class="va">tagged_tables</span> <span class="op">&lt;-</span> <span class="va">connector_object</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/list_content_cnt.html">list_content_cnt</a></span><span class="op">(</span>tags <span class="op">=</span> <span class="op">(</span><span class="va">tag_name</span> <span class="op">==</span> <span class="st">"source"</span> <span class="op">&amp;&amp;</span> <span class="va">tag_value</span> <span class="op">==</span> <span class="st">"example"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>The <code>list_content_cnt</code> method can filter tables based on
their tags. It translates the tag filtering expression into SQL and
queries the Databricks system tables to find matching tables.</p>
</div>
<div class="section level2">
<h2 id="working-with-table-references">Working with Table References<a class="anchor" aria-label="anchor" href="#working-with-table-references"></a>
</h2>
<p>You can create a reference to a Databricks table using the
<code><a href="../reference/tbl_cnt.html">tbl_cnt()</a></code> method:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">table_ref</span> <span class="op">&lt;-</span> <span class="va">connector_object</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/tbl_cnt.html">tbl_cnt</a></span><span class="op">(</span><span class="st">"my_table"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Use dplyr operations on the table reference</span></span>
<span><span class="va">filtered_data</span> <span class="op">&lt;-</span> <span class="va">table_ref</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">age</span> <span class="op">&gt;</span> <span class="fl">30</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/compute.html" class="external-link">collect</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>The <code><a href="../reference/tbl_cnt.html">tbl_cnt()</a></code> method creates a reference to the table
that can be used with dplyr operations. These operations are translated
to SQL and executed on the Databricks cluster, allowing for efficient
processing of large datasets.</p>
</div>
<div class="section level2">
<h2 id="conclusion">Conclusion<a class="anchor" aria-label="anchor" href="#conclusion"></a>
</h2>
<p>This vignette demonstrated the basic usage of custom functions for
reading from and writing to Databricks tables. These functions provide a
convenient interface for working with Databricks, including features
like time travel, tagging, and easy integration with dplyr
operations.</p>
<p>The writing mechanism uses temporary volumes and Parquet files for
efficient data transfer, while the reading mechanism leverages SQL
queries and Arrow streaming for performance. Both methods take advantage
of Databricks’ Delta Lake architecture, providing features like ACID
transactions, time travel, and metadata management.</p>
<p>Remember to refer to the documentation of individual functions for
more detailed information on their usage and parameters.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Steffen Falgreen Larsen, Aksel Thomsen, Vladimir Obucina, Cervan Girard.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.2.</p>
</div>

    </footer>
</div>





  </body>
</html>
